import openai
import os
from dotenv import load_dotenv

# .env 파일 로드
load_dotenv()

# OpenAI API 키 설정
api_key = os.getenv("OPENAI_API_KEY")

# OpenAI 클라이언트 초기화
client = openai.OpenAI(api_key=api_key)

def summarize_text(input_text):
    """ OpenAI GPT-4o 모델을 사용하여 상담 내용을 체계적으로 요약하는 함수 """
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": 
                    "주어진 상담 내용을 논리적으로 정리하고, 세세한 내용을 빠짐없이 요약해줘. "
                    "대화 내용이 혼란스럽거나 여러 주제를 포함하고 있어도, 핵심 내용을 찾아 구조화된 요약을 제공해야 해.\n\n"

                    "💡 **요약 규칙**\n"
                    "- 상담 내용이 많으면 자동으로 카테고리를 만들어 분류할 것.\n"
                    "- 수치(금액, 일정 등)는 반드시 포함하여 기록할 것.\n"
                    "- 고객이 중요하게 여기는 부분을 강조하여 표시할 것.\n"
                    "- 내용이 많아도 명확하고 체계적으로 정리할 것.\n\n"

                    "📌 **요약 형식**\n"
                    "1. **상담 개요** (3~5줄 요약)\n"
                    "2. **세부 내용 정리** (항목별 정리, 세부 사항 포함)\n"
                    "3. **중요 일정 및 금액 정리** (해당 내용이 있을 경우 별도 정리)\n\n"

                    "✅ **예시**\n"
                    "### **1. 상담 개요**\n"
                    "- 고객이 기존 거주 공간을 부분 리모델링하려고 상담.\n"
                    "- 주방, 거실, 욕실 개선 및 창호 교체 관련 논의.\n"
                    "- 강아지 관리, 육아 부담, 가사 도우미 활용도 함께 논의됨.\n\n"

                    "### **2. 세부 내용 정리**\n"
                    "**1. 인테리어 및 공사**\n"
                    "- 주방: 싱크대 교체 여부 논의 (LG 제품 vs 한샘)\n"
                    "- 욕실: 대림 바스 제품 검토, 웰스 코팅 추가 가능성 검토\n"
                    "- 창호: 기존 엘지 246mm 샤시 대체 가능 여부 확인 필요\n"
                    "- 몰딩 없는 심플 디자인 선호, 도장 마감 vs 필름 마감 논의\n\n"

                    "**2. 강아지 관리**\n"
                    "- 털 빠짐 문제로 자동 청소기 사용 검토\n"
                    "- 하루 3회 산책 (아침, 점심, 저녁) 패턴 유지\n\n"

                    "**3. 육아 및 가사 부담**\n"
                    "- 맞벌이 부부로 인해 가사 도우미 활용 (주 2~3회 방문)\n"
                    "- 정부 지원 가사 도우미 프로그램 여부 논의\n\n"

                    "### **3. 중요 일정 및 금액 정리**\n"
                    "- 공사 일정: 5월 6일 또는 5월 15일 중 선택 예정\n"
                    "- 예상 비용: 샤시 교체 320만 원, 욕실 개선 180만 원\n"
                    "(VAT 포함 총 500만 원 예상)\n"
                    "...\n"
                    "(위와 같은 방식으로 상담 내용을 세부적으로 정리할 것.)"
                },
                {"role": "user", "content": input_text}
            ]
        )
        return response.choices[0].message.content
    except Exception as e:
        print(f"❌ 요약 오류 발생: {e}")
        return "요약 실패"